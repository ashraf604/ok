const { formatNumber } = require(\"./database_helpers.js\");\n\nfunction formatPrivateBuy(details) {\n    const { asset, price, amountChange, tradeValue, oldTotalValue, newAssetWeight, newUsdtValue, newCashPercent } = details;\n    const tradeSizePercent = oldTotalValue > 0 ? (tradeValue / oldTotalValue) * 100 : 0;\n\n    let msg = `*مراقبة الأصول 🔬:*\\n**عملية استحواذ جديدة 🟢**\\n━━━━━━━━━━━━━━━━━━━━\\n`;\n    msg += `🔸 **الأصل المستهدف:** \\`${asset}/USDT\\`\\n`;\n    msg += `🔸 **نوع العملية:** تعزيز مركز / بناء مركز جديد\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*تحليل الصفقة:*\\n`;\n    msg += ` ▪️ **سعر التنفيذ:** \\`$${formatNumber(price, 4)}\\`\\n`;\n    msg += ` ▪️ **الكمية المضافة:** \\`${formatNumber(Math.abs(amountChange), 6)}\\`\\n`;\n    msg += ` ▪️ **التكلفة الإجمالية للصفقة:** \\`$${formatNumber(tradeValue)}\\`\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*التأثير على هيكل المحفظة:*\\n`;\n    msg += ` ▪️ **حجم الصفقة من إجمالي المحفظة:** \\`${formatNumber(tradeSizePercent)}%\\`\\n`;\n    msg += ` ▪️ **الوزن الجديد للأصل:** \\`${formatNumber(newAssetWeight)}%\\`\\n`;\n    msg += ` ▪️ **السيولة المتبقية (USDT):** \\`$${formatNumber(newUsdtValue)}\\`\\n`;\n    msg += ` ▪️ **مؤشر السيولة الحالي:** \\`${formatNumber(newCashPercent)}%\\`\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*بتاريخ:* ${new Date().toLocaleString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}`;\n    return msg;\n}\n\nfunction formatPrivateSell(details) {\n    const { asset, price, amountChange, tradeValue, oldTotalValue, newAssetWeight, newUsdtValue, newCashPercent } = details;\n    const tradeSizePercent = oldTotalValue > 0 ? (tradeValue / oldTotalValue) * 100 : 0;\n    \n    let msg = `*مراقبة الأصول 🔬:*\\n**مناورة تكتيكية 🟠**\\n━━━━━━━━━━━━━━━━━━━━\\n`;\n    msg += `🔸 **الأصل المستهدف:** \\`${asset}/USDT\\`\\n`;\n    msg += `🔸 **نوع العملية:** تخفيف المركز / جني أرباح جزئي\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*تحليل الصفقة:*\\n`;\n    msg += ` ▪️ **سعر التنفيذ:** \\`$${formatNumber(price, 4)}\\`\\n`;\n    msg += ` ▪️ **الكمية المخففة:** \\`${formatNumber(Math.abs(amountChange), 6)}\\`\\n`;\n    msg += ` ▪️ **العائد الإجمالي للصفقة:** \\`$${formatNumber(tradeValue)}\\`\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*التأثير على هيكل المحفظة:*\\n`;\n    msg += ` ▪️ **حجم الصفقة من إجمالي المحفظة:** \\`${formatNumber(tradeSizePercent)}%\\`\\n`;\n    msg += ` ▪️ **الوزن الجديد للأصل:** \\`${formatNumber(newAssetWeight)}%\\`\\n`;\n    msg += ` ▪️ **السيولة الجديدة (USDT):** \\`$${formatNumber(newUsdtValue)}\\`\\n`;\n    msg += ` ▪️ **مؤشر السيولة الحالي:** \\`${formatNumber(newCashPercent)}%\\`\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*بتاريخ:* ${new Date().toLocaleString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}`;\n    return msg;\n}\n\nfunction formatPrivateCloseReport(details) {\n    const { asset, avgBuyPrice, avgSellPrice, pnl, pnlPercent, durationDays, highestPrice, lowestPrice } = details;\n    const pnlSign = pnl >= 0 ? \u2018+\u2019 : \u2018\u2019;\n    const emoji = pnl >= 0 ? \u2018\uD83D\uDFE2\u2019 : \u2018\uD83D\uDD34\u2019;\n\n    let msg = `*ملف المهمة الختامي ${emoji}*\\n**${asset}/USDT**\\n━━━━━━━━━━━━━━━━━━━━\\n`;\n    msg += `🔸 **متوسط سعر الشراء:** \\`$${formatNumber(avgBuyPrice, 4)}\\`\\n`;\n    msg += `🔸 **متوسط سعر البيع:** \\`$${formatNumber(avgSellPrice, 4)}\\`\\n`;\n    msg += `🔸 **الربح/الخسارة المحققة:** \\`${pnlSign}$${formatNumber(pnl)}\\` (${pnlSign}${formatNumber(pnlPercent)}%)\\n`;\n    msg += `🔸 **مدة الصفقة:** \\`${formatNumber(durationDays, 1)}\\` يوم\\n`;\n    msg += `🔸 **أعلى سعر خلال الصفقة:** \\`$${formatNumber(highestPrice, 4)}\\`\\n`;\n    msg += `🔸 **أدنى سعر خلال الصفقة:** \\`$${formatNumber(lowestPrice, 4)}\\`\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n*بتاريخ:* ${new Date().toLocaleString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}`;\n    return msg;\n}\n\nfunction formatPortfolioMessage(portfolio, prices) {\n    let msg = `*📊 ملخص المحفظة (${new Date().toLocaleDateString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}):*\\n\\n`;\n    if (portfolio.error) {\n        msg += `⚠️ ${portfolio.error}\\n`;\n        return msg;\n    }\n\n    msg += `*القيمة الإجمالية:* \\`$${formatNumber(portfolio.total)}\\`\\n`;\n    msg += `*السيولة (USDT):* \\`$${formatNumber(portfolio.usdtValue)}\\`\\n\\n`;\n\n    if (portfolio.assets.length > 0) {\n        msg += `*الأصول:*\n`;\n        portfolio.assets.forEach(asset => {\n            const changeEmoji = asset.change24h >= 0 ? (asset.change24h > 0 ? '📈' : '') : '📉';\n            const changeText = asset.change24h !== 0 ? ` (${formatNumber(asset.change24h * 100, 2)}%)` : '';\n            msg += `\u2022 ${asset.asset}: \\`$${formatNumber(asset.value)}\\` (${formatNumber(asset.amount, 4)} ${asset.asset}) ${changeEmoji}${changeText}\\n`;\n        });\n    } else {\n        msg += `لا توجد أصول في المحفظة حاليًا.\\n`;\n    }\n    return msg;\n}\n\nfunction formatDailySummary(summary) {\n    let msg = `*📈 ملخص الأداء اليومي (${new Date().toLocaleDateString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}):*\\n\\n`;\n    if (summary.error) {\n        msg += `⚠️ ${summary.error}\\n`;\n        return msg;\n    }\n\n    const pnlEmoji = summary.pnl >= 0 ? '🟢' : '🔴';\n    const pnlSign = summary.pnl >= 0 ? '+' : '';\n\n    msg += `*القيمة الافتتاحية:* \\`$${formatNumber(summary.startValue)}\\`\\n`;\n    msg += `*القيمة الختامية:* \\`$${formatNumber(summary.endValue)}\\`\\n`;\n    msg += `*الربح/الخسارة اليومية:* ${pnlEmoji} \\`${pnlSign}$${formatNumber(summary.pnl)}\\` (${pnlSign}${formatNumber(summary.pnlPercent)}%)\\n`;\n    msg += `*أعلى قيمة:* \\`$${formatNumber(summary.maxValue)}\\`\\n`;\n    msg += `*أدنى قيمة:* \\`$${formatNumber(summary.minValue)}\\`\\n\\n`;\n\n    if (summary.chartUrl) {\n        msg += `[عرض الرسم البياني](${summary.chartUrl})\\n`;\n    }\n\n    return msg;\n}\n\nfunction formatTechnicalAnalysisMessage(instId, analysis) {\n    let msg = `*تحليل فني لـ ${instId.toUpperCase()}*\\n━━━━━━━━━━━━━━━━━━━━\\n`;\n    if (analysis.error) {\n        msg += `⚠️ ${analysis.error}\\n`;\n        return msg;\n    }\n\n    msg += `🔸 *مؤشر القوة النسبية (RSI):* \\`${formatNumber(analysis.rsi, 2)}\\`\\n`;\n    msg += `🔸 *المتوسط المتحرك البسيط (SMA20):* \\`$${formatNumber(analysis.sma20, 4)}\\`\\n`;\n    msg += `🔸 *المتوسط المتحرك البسيط (SMA50):* \\`$${formatNumber(analysis.sma50, 4)}\\`\\n`;\n    msg += `━━━━━━━━━━━━━━━━━━━━\\n`;\n    return msg;\n}\n\nfunction formatPriceAlertMessage(alert) {\n    return `🔔 *تنبيه سعر:*\\nالأصل: *${alert.instId}*\\nالسعر الحالي: \\`$${formatNumber(alert.currentPrice, 4)}\\`\\nالسعر المستهدف: \\`$${formatNumber(alert.targetPrice, 4)}\\`\\nالاتجاه: *${alert.direction === 'above' ? 'أعلى من' : 'أقل من'}*\\n`;\n}\n\nfunction formatVirtualTradeSummary(trade) {\n    let msg = `*صفقة افتراضية جديدة 📊*\\n`;\n    msg += `الأصل: *${trade.asset}*\\n`;\n    msg += `الكمية: \\`${formatNumber(trade.amount, 4)}\\`\\n`;\n    msg += `سعر الدخول: \\`$${formatNumber(trade.entryPrice, 4)}\\`\\n`;\n    msg += `تاريخ الدخول: ${new Date(trade.enteredAt).toLocaleString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}\\n`;\n    msg += `الحالة: *${trade.status}*\\n`;\n    if (trade.status === 'closed') {\n        msg += `سعر الإغلاق: \\`$${formatNumber(trade.closePrice, 4)}\\`\\n`;\n        msg += `تاريخ الإغلاق: ${new Date(trade.closedAt).toLocaleString(\"ar-EG\", { timeZone: \"Africa/Cairo\" })}\\n`;\n        const pnl = (trade.closePrice - trade.entryPrice) * trade.amount;\n        const pnlPercent = (pnl / (trade.entryPrice * trade.amount)) * 100;\n        const pnlEmoji = pnl >= 0 ? '🟢' : '🔴';\n        const pnlSign = pnl >= 0 ? '+' : '';\n        msg += `الربح/الخسارة: ${pnlEmoji} \\`${pnlSign}$${formatNumber(pnl)}\\` (${pnlSign}${formatNumber(pnlPercent)}%)\\n`;\n    }\n    return msg;\n}\n\nmodule.exports = {\n    formatPrivateBuy,\n    formatPrivateSell,\n    formatPrivateCloseReport,\n    formatPortfolioMessage,\n    formatDailySummary,\n    formatTechnicalAnalysisMessage,\n    formatPriceAlertMessage,\n    formatVirtualTradeSummary\n};

